"use strict";module.exports=({init:e},{env:a,services:o,database:t,getSchema:n})=>{e("middlewares.before",async function({app:e}){console.log("!!! MIDDLEWARE EXTENSION LOADED (router helper) !!!");const{ItemsService:a}=o;e.get("/ventas/health",(e,a)=>{a.json({data:{status:"ok"}})}),e.post("/ventas/reprocesar/:ventaId",async(e,s)=>{try{if(!e.accountability||!e.accountability.admin&&!e.accountability.role)return s.status(401).json({errors:[{message:"No autenticado"}]});if(e.accountability&&!0!==e.accountability.admin){if(!(process.env.VENTAS_WRITE_ROLES||"").split(",").map(e=>e.trim()).filter(Boolean).includes(String(e.accountability.role||"")))return s.status(403).json({errors:[{message:"No autorizado"}]})}const i=e.params.ventaId,r=await t.transaction(),c={schema:await n(),knex:r,accountability:{admin:!0}},m=new a("ventas",c),d=new a("vendedores",c),p=new a("comisiones",c),l=await m.readOne(i);if(!l)return await r.rollback(),s.status(404).json({errors:[{message:"Venta no encontrada"}]});let u=l.vendedor_id||null;if(!u)try{const F=await d.readByQuery({limit:1});F&&F.length>0&&(u=F[0].id)}catch{}async function _(e){try{if(e?.raw){const a=await e.raw("SHOW COLUMNS FROM `comisiones`"),o=(Array.isArray(a)?Array.isArray(a[0])?a[0]:a:a?.[0]||[]).map(e=>(e.Field||e.COLUMN_NAME||"").toLowerCase());return{hasPorcentaje:o.includes("porcentaje"),hasPorcentajeComision:o.includes("porcentaje_comision")}}}catch{}return{hasPorcentaje:!1,hasPorcentajeComision:!0}}const j=await _(t);let h=5,w="porcentaje",g=0;if(u)try{const C=await d.readOne(u);null!=C?.comision_porcentaje&&(h=parseFloat(C.comision_porcentaje)),C?.comision_esquema&&(w=String(C.comision_esquema).toLowerCase()),null!=C?.comision_fija&&(g=parseFloat(C.comision_fija))}catch{}const v=[{name:"Enganche",pct:.3},{name:"Contrato",pct:.3},{name:"Liquidación",pct:.4}],f=[],y=parseFloat(l.monto_total||0);if("fijo"===w){const O={venta_id:l.id,vendedor_id:u,tipo_comision:"Comisión Fija",monto_venta:y,monto_comision:parseFloat(g.toFixed(2)),estatus:"pendiente",fecha_pago_programada:(new Date).toISOString().split("T")[0],notas:"Reprocesado: esquema fijo"};j.hasPorcentajeComision&&(O.porcentaje_comision=0),j.hasPorcentaje&&(O.porcentaje=0),f.push(O)}else{for(const b of v){const E=h*b.pct,I=y*(E/100),P={venta_id:l.id,vendedor_id:u,tipo_comision:`Comisión ${b.name}`,monto_venta:y,monto_comision:parseFloat(I.toFixed(2)),estatus:"pendiente",fecha_pago_programada:(new Date).toISOString().split("T")[0],notas:`Reprocesado. Concepto: ${b.name} (${(100*b.pct).toFixed(0)}% del total)`},x=parseFloat(E.toFixed(2));j.hasPorcentajeComision&&(P.porcentaje_comision=x),j.hasPorcentaje&&(P.porcentaje=x),f.push(P)}if("mixto"===w&&g>0){const N={venta_id:l.id,vendedor_id:u,tipo_comision:"Comisión Fija",monto_venta:y,monto_comision:parseFloat(g.toFixed(2)),estatus:"pendiente",fecha_pago_programada:(new Date).toISOString().split("T")[0],notas:"Reprocesado: esquema mixto"};j.hasPorcentajeComision&&(N.porcentaje_comision=0),j.hasPorcentaje&&(N.porcentaje=0),f.push(N)}}if(0===f.length)return await r.rollback(),s.status(400).json({errors:[{message:"No se pudieron determinar comisiones"}]});await r("comisiones").where({venta_id:l.id}).del();const S=await p.createMany(f);return await m.updateOne(l.id,{post_process_status:"ok",post_process_error:null}),await r.commit(),s.status(201).json({data:{venta_id:l.id,comisiones:S?.length||f.length}})}catch(A){console.error("❌ Error reprocesando (middleware):",A);try{const L=await n(),D=new o.ItemsService("ventas",{schema:L,accountability:{admin:!0}});await D.updateOne(e.params.ventaId,{post_process_status:"error",post_process_error:String(A?.message||A)})}catch{}return s.status(500).json({errors:[{message:A.message||String(A)}]})}})})};
