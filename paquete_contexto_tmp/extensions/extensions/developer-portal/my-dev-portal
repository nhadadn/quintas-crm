import e from"crypto";let r;const t=new Uint8Array(16);function o(){if(!r&&(r="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!r))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return r(t)}const n=[];for(let e=0;e<256;++e)n.push((e+256).toString(16).slice(1));var s={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function a(e,r,t){if(s.randomUUID&&!r&&!e)return s.randomUUID();const a=(e=e||{}).random||(e.rng||o)();if(a[6]=15&a[6]|64,a[8]=63&a[8]|128,r){t=t||0;for(let e=0;e<16;++e)r[t+e]=a[e];return r}return function(e,r=0){return n[e[r+0]]+n[e[r+1]]+n[e[r+2]]+n[e[r+3]]+"-"+n[e[r+4]]+n[e[r+5]]+"-"+n[e[r+6]]+n[e[r+7]]+"-"+n[e[r+8]]+n[e[r+9]]+"-"+n[e[r+10]]+n[e[r+11]]+n[e[r+12]]+n[e[r+13]]+n[e[r+14]]+n[e[r+15]]}(a)}console.log("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!"),console.log("LOADING MY-DEV-PORTAL EXTENSION - FINAL BUILD"),console.log("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!");var c=(r,t)=>{const{services:o,getSchema:n,database:s}=t,{ItemsService:c}=o;console.log("REGISTERING MY-DEV-PORTAL ROUTES"),r.get("/ping",(e,r)=>{console.log("GET /ping called"),r.send("pong")}),r.post("/register-app",async(r,t)=>{if(console.log("POST /register-app called"),!r.accountability||!r.accountability.user)return console.log("User not authenticated"),t.status(401).json({error:"User not authenticated"});const{app_name:o,redirect_urls:i}=r.body;if(!o||!i)return console.log("Missing required fields",r.body),t.status(400).json({error:"Missing required fields: app_name, redirect_urls"});try{const l=await n(),u=new c("oauth_clients",{schema:l,knex:s}),d=a(),p=e.randomBytes(32).toString("hex"),g={id:d,name:o,redirect_uris:i,secret:p,user_created:r.accountability.user};console.log("Creating oauth client:",g),await u.createOne(g),t.json({client_id:d,client_secret:p,app_name:o,redirect_urls:i})}catch(e){console.error("Error registering app:",e),t.status(500).json({error:"Internal Server Error",message:e.message})}})};export{c as default};
