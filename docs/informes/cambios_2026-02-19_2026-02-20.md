# Informe técnico de cambios – 19 y 20 de febrero de 2026

## 1. Alcance y contexto

- **Rango de fechas considerado:** 2026-02-19 a 2026-02-20
- **Base de comparación (HEAD):** 06e26cc695c8b70a7291d2eccfdf6488f41168b0
- **Estado actual:** Cambios locales sin commit (working tree sucio)
- **Responsable operativo de estos cambios locales:** usuario del workspace `nadir` (Windows)

> ℹ️ No existen commits fechados explícitamente en este rango de fechas; el informe se basa en el diff entre el HEAD indicado y el estado actual del árbol de trabajo.

## 2. Resumen ejecutivo

Cambios principales introducidos en los últimos dos días:

- **Infraestructura y DevOps**
  - Actualización de `.env.docker.example`, `Dockerfile.directus`, `docker-compose.yml` y `directus-entrypoint.sh`.
  - Ajustes en `.gitignore` para contemplar nuevos artefactos de build y pruebas.
  - Ajustes en la migración `009_create_oauth_schema.sql` relacionados con el esquema OAuth.

- **Directus y extensiones**
  - Ajustes en extensiones de amortización, recibos, dashboard y middleware OAuth.
  - Nuevos scripts para asegurar permisos y metadatos de la vista analítica `v_dashboard_kpis`.
  - Script `build-extensions.mjs` para generar wrappers uniformes de extensiones.

- **APIs de dashboard (frontend)**
  - Refactor de `/api/dashboard/kpis` para consumir `crm-analytics/kpis` desde Directus.
  - Ajustes en rutas de dashboard para ventas por mes, ventas por vendedor, comisiones por vendedor y pagos por estatus.

- **Frontend – Dashboard interno**
  - Dashboard de Ventas reforzado con auto-refresh, `BroadcastChannel` y gating de gráficos.
  - Nuevos componentes visuales (tarjetas de KPIs con sparkline y gráfico de ingresos mensuales con Recharts).

- **Frontend – Portal de clientes**
  - Mejoras en flujos de pagos y documentos (tablas, modales y layouts del portal).

- **Frontend – Flujos de venta / wizard**
  - Ajustes en todos los pasos del wizard de venta y tablas de gestión (ventas, pagos, comisiones, clientes, vendedores).

- **Librerías, configuración y tooling**
  - Actualización de `package.json`/`package-lock.json` en `frontend` y raíz.
  - Adaptaciones en `tailwind.config.ts` (raíz y frontend), nuevos estilos globales y shell `app/`.
  - Incorporación de tests unitarios e integrales para el dashboard de KPIs.

## 3. Detalle por área/módulo (resumen)

### 3.1 Infraestructura y DevOps

**Archivos relevantes:**

- `.env.docker.example`
- `.gitignore`
- `Dockerfile.directus`
- `directus-entrypoint.sh`
- `docker-compose.yml`
- `database/migrations/009_create_oauth_schema.sql`

**Impacto:**

- Sincroniza variables de entorno con los nuevos scripts y vistas analíticas.
- Mejora el arranque de Directus y la coherencia entre entorno local y productivo.
- Asegura que el esquema OAuth esté alineado con los cambios de autenticación.

### 3.2 Directus y extensiones

**Archivos relevantes (selección):**

- `extensions/amortizacion/package.json`
- `extensions/dashboard/src/index.js`
- `extensions/dashboard/src/permissions.js`
- `extensions/middleware/index.js`
- `extensions/middleware/oauth-auth.mjs`
- `extensions/middleware/package.json`
- `extensions/recibos/package.json`
- `extensions/recibos/src/index.js`
- `extensions/ventas-api/package-lock.json`
- `scripts/build-extensions.mjs`
- `scripts/grant_kpis_permission.js`
- `scripts/force_fix_kpis_permission.js`

**Cambios clave:**

- Homogeneización de dependencias en extensiones.
- Refuerzo del middleware OAuth para adaptarse a la migración 009.
- Automatización de permisos de lectura sobre `v_dashboard_kpis` para roles `Cliente`, `Vendedor` y usuario de servicio.
- Generación automatizada de wrappers ESM/CJS para extensiones mediante `build-extensions.mjs`.

### 3.3 APIs de dashboard y analítica (frontend)

**Archivos relevantes:**

- `frontend/app/api/dashboard/kpis/route.ts`
- `frontend/app/api/dashboard/ventas-por-mes/route.ts`
- `frontend/app/api/dashboard/ventas-por-vendedor/route.ts`
- `frontend/app/api/dashboard/ventas-recientes/route.ts`
- `frontend/app/api/dashboard/comisiones-por-vendedor/route.ts`
- `frontend/app/api/dashboard/pagos-por-estatus/route.ts`
- `frontend/lib/dashboard-api.ts`
- `frontend/lib/directus-api.ts`
- `frontend/lib/pagos-api.ts`
- `frontend/lib/utils.ts`

**Cambios clave:**

- `/api/dashboard/kpis` ahora obtiene todos los KPIs desde `crm-analytics/kpis` con una única llamada.
- Respuestas de error estructuradas con `{ statusCode, message, timestamp, path }`.
- Cliente `fetchKPIs` con reintentos y mensajes de error amigables en español.

### 3.4 Frontend – Dashboard interno

**Archivos relevantes:**

- `frontend/app/dashboard/ventas/page.tsx`
- `frontend/components/dashboard/KPICard.tsx`
- `frontend/components/dashboard/charts.tsx`
- `frontend/components/dashboard/kpi-card.tsx`
- `frontend/components/ui/InfoTooltip.tsx`

**Cambios clave:**

- Carga en paralelo de KPIs, ventas por mes y ventas recientes.
- Auto-refresh con detección de pestaña visible.
- Gating del gráfico de ventas por mes según el tamaño real del contenedor.
- Incorporación de tarjetas de KPIs con sparkline y gráfico de ingresos mensuales (Recharts).

### 3.5 Frontend – Portal de clientes

**Archivos relevantes:**

- `frontend/app/portal/(dashboard)/layout.tsx`
- `frontend/app/portal/(dashboard)/page.tsx`
- `frontend/app/portal/(dashboard)/documentos/page.tsx`
- `frontend/app/portal/(dashboard)/pagos/page.tsx`
- `frontend/app/portal/pagos/confirmacion/page.tsx`
- `frontend/components/portal/PortalNavbar.tsx`
- `frontend/components/portal/PortalFooter.tsx`
- `frontend/components/portal/documentos/TablaDocumentosCliente.tsx`
- `frontend/components/portal/pagos/ModalPagoStripe.tsx`
- `frontend/components/portal/pagos/ModalSolicitarReembolso.tsx`
- `frontend/components/portal/pagos/TablaPagosCliente.tsx`

**Cambios clave:**

- Refinamiento de flujos de pago (confirmación, reembolsos, tabla de pagos).
- Mejoras en la visualización de documentos por cliente.
- Alineación de layout y navegación con la identidad visual global del proyecto.

### 3.6 Frontend – Flujos de venta / wizard

**Archivos relevantes:**

- `frontend/components/wizard/Step1SeleccionLote.tsx`
- `frontend/components/wizard/Step2DatosCliente.tsx`
- `frontend/components/wizard/Step3TerminosVenta.tsx`
- `frontend/components/wizard/Step4Confirmacion.tsx`
- `frontend/components/wizard/WizardVenta.tsx`
- `frontend/components/gestion/TablaVentas.tsx`
- `frontend/components/gestion/TablaPagos.tsx`
- `frontend/components/gestion/TablaComisiones.tsx`
- `frontend/components/gestion/TablaClientes.tsx`
- `frontend/components/gestion/TablaVendedores.tsx`
- `frontend/components/pagos/ModalRegistrarPago.tsx`

**Cambios clave:**

- Validaciones mejoradas y mensajes de error en español.
- Mejor consistencia en cálculos de montos, amortización y comisiones.
- Integración con el mapa de lotes para selección de inventario.

### 3.7 Shell unificada y diseño

**Archivos relevantes:**

- `app/layout.tsx`
- `components/layout/sidebar.tsx`
- `components/layout/topbar.tsx`
- `components/theme-check.tsx`
- `styles/`
- `tailwind.config.ts` (raíz)

**Cambios clave:**

- Nueva shell de aplicación con sidebar y topbar estilo "Quintas OS".
- Centralización de estilos y tokens de diseño.

## 4. Pruebas asociadas

**Tests relevantes a estos cambios:**

- `frontend/tests/unit/api-kpis-route.spec.ts`
  - Valida el contrato de la ruta `/api/dashboard/kpis` y la propagación de errores.
- `frontend/tests/integration/dashboard-kpis.integration.spec.tsx`
  - Verifica el comportamiento del Dashboard de Ventas (skeleton vs gráfico) en función del tamaño del contenedor y la respuesta de KPIs.

Se recomienda ejecutar las suites de tests en la carpeta `frontend` tras actualizar dependencias.

## 5. Instrucciones de actualización resumidas

1. Actualizar dependencias en raíz y en `frontend/` (`npm install`).
2. Configurar variables de entorno desde `.env.docker.example`.
3. Aplicar la migración `009_create_oauth_schema.sql` en la base de datos.
4. Ejecutar `node scripts/force_fix_kpis_permission.js` para asegurar colección y permisos de `v_dashboard_kpis`.
5. Ejecutar `node scripts/grant_kpis_permission.js` para garantizar permisos de lectura en políticas de clientes y vendedores.
6. Ejecutar `node scripts/build-extensions.mjs` para regenerar wrappers de extensiones.
7. Reiniciar contenedores (`docker compose ...`) y ejecutar tests de `frontend`.
